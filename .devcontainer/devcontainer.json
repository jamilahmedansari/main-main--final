// For format details, see https://aka.ms/devcontainer.json
// Talk-To-My-Lawyer: Next.js 16 + Supabase + Stripe + AI SaaS
// Using custom Dockerfile for full control
{
	"name": "Talk-To-My-Lawyer Dev",
	
	// Use docker-compose for orchestration
	"dockerComposeFile": "docker-compose.yml",
	"service": "app",
	"workspaceFolder": "/workspace",

	// Run as the built-in node user from the base image
	"remoteUser": "node",

	// Reuse host git identity inside the container (fixes: "Author identity unknown")
	"mounts": [
		"source=${localEnv:HOME}/.gitconfig,target=/home/node/.gitconfig,type=bind,consistency=cached",
		"source=${localEnv:HOME}/.config/git,target=/home/node/.config/git,type=bind,consistency=cached"
	],

	// Forward ports for development
	"forwardPorts": [3000, 54321, 54322, 4242],

	"portsAttributes": {
		"3000": {
			"label": "Next.js App",
			"onAutoForward": "notify"
		},
		"54321": {
			"label": "Supabase Studio",
			"onAutoForward": "silent"
		},
		"54322": {
			"label": "Supabase API", 
			"onAutoForward": "silent"
		},
		"4242": {
			"label": "Stripe Webhooks",
			"onAutoForward": "silent"
		}
	},

	// Run after container creation
	"postCreateCommand": "pnpm install && (cp -n .env.example .env.local 2>/dev/null || true) && (git config --global --add safe.directory /workspace || true)",

	// Run on every start
	"postStartCommand": "bash -lc \"echo '✅ Ready! Run: pnpm dev'; name=\\\"\\$(git config --get user.name 2>/dev/null)\\\"; email=\\\"\\$(git config --get user.email 2>/dev/null)\\\"; if [ -z \\\"$$name\\\" ] || [ -z \\\"$$email\\\" ]; then echo; echo '⚠️  Git identity not set inside container (commits may fail).'; echo 'Set it on your host (recommended):'; echo '  git config --global user.name \"Your Name\"'; echo '  git config --global user.email \"you@example.com\"'; echo; fi\"",

	// VS Code customizations
	"customizations": {
		"vscode": {
			"extensions": [
				"dbaeumer.vscode-eslint",
				"esbenp.prettier-vscode",
				"bradlc.vscode-tailwindcss",
				"github.vscode-pull-request-github",
				"eamodio.gitlens",
				"mikestead.dotenv",
				"christian-kohler.path-intellisense",
				"formulahendry.auto-rename-tag",
				"github.copilot",
				"github.copilot-chat",
				"usernamehw.errorlens"
			],
			"settings": {
				// Shell integration
				"terminal.integrated.shellIntegration.enabled": true,
				"terminal.integrated.defaultProfile.linux": "bash",
				
				// Editor
				"editor.defaultFormatter": null,
				"editor.formatOnSave": true,
				"editor.codeActionsOnSave": {
					"source.fixAll.eslint": "explicit"
				},
				"editor.tabSize": 2,
				"editor.minimap.enabled": false,
				
				// TypeScript
				"typescript.preferences.importModuleSpecifier": "relative",
				"typescript.suggest.autoImports": true,
				"typescript.updateImportsOnFileMove.enabled": "always",
				
				// ESLint
				"eslint.validate": [
					"javascript",
					"javascriptreact", 
					"typescript",
					"typescriptreact"
				],
				"eslint.run": "onSave",
				
				// Tailwind
				"tailwindCSS.includeLanguages": {
					"typescript": "javascript",
					"typescriptreact": "javascriptreact"
				},
				"tailwindCSS.emmetCompletions": true,
				
				// Files
				"files.associations": {
					"*.css": "tailwindcss",
					".env*": "dotenv"
				},
				"files.watcherExclude": {
					"**/node_modules/**": true,
					"**/.git/**": true,
					"**/.next/**": true
				},
				
				// Git
				"git.enableSmartCommit": true,
				"git.autofetch": true,
				
				// Misc
				"telemetry.telemetryLevel": "off"
			}
		}
	}
}
